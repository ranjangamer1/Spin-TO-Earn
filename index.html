<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Earning App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700,900&family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* =============================================== */
        /* === 1. DESIGN SYSTEM & GLOBAL STYLES === */
        /* =============================================== */
        :root {
            --primary-green: #28a745; --primary-dark-green: #006400; --primary-orange: #ffc107;
            --text-dark: #2c3e50; --text-light: #fff; --text-subtle: #95a5a6;
            --background-light: #f4f7f6; --border-color: #eef0f1; --mining-dark-bg: #1a202c;
            --mining-teal: #38f9d7; --grad-green: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --grad-red: linear-gradient(to right, #f5af19, #f12711); --grad-lucky-wheel: linear-gradient(to right, #fdeec9, #f8d79a);
            --grad-daily-checkin: linear-gradient(to right, #fecd7f, #fca652); --grad-subscribe: linear-gradient(to right, #d8deff, #c2cbfb);
            --grad-invitation: linear-gradient(to right, #eadcff, #dcc6ff);
            --spacing-sm: 8px; --spacing-md: 16px; --spacing-lg: 24px; --border-radius: 20px;
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background-color: var(--background-light); color: var(--text-dark); overscroll-behavior-y: contain; line-height: 1.6; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        #app { max-width: 450px; margin: auto; background-color: #fff; min-height: 100vh; position: relative; padding-bottom: 70px; overflow: hidden; box-shadow: 0 0 30px rgba(0,0,0,0.1); }
        .page { display: none; animation: fadeIn 0.3s ease-in-out; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .main-content { padding: var(--spacing-md); }
        .header { display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-md); color: var(--text-light); background: var(--grad-green); }
        .header .balance-info { display: flex; gap: 10px; }
        .header .balance, .header .ad-chances { background-color: rgba(255, 255, 255, 0.2); padding: 5px 15px; border-radius: 20px; font-weight: 500; }
        .header-title { font-weight: 700; font-size: 1.1em; position: absolute; left: 50%; transform: translateX(-50%); }
        .back-btn { cursor: pointer; font-size: 1.2em; z-index: 10; }
        .card { background-color: #fff; border-radius: var(--border-radius); padding: var(--spacing-md); margin-bottom: var(--spacing-md); box-shadow: var(--shadow-md); }
        .btn { padding: 10px 25px; border: none; border-radius: 25px; font-weight: 700; cursor: pointer; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.2s ease; }
        .btn i.fa-video { margin-right: 8px; }
        .btn:active { transform: scale(0.95); }
        .btn-get { background-color: var(--primary-orange); color: var(--text-dark); }
        .btn-claimed { background-color: #e0e0e0; color: #9e9e9e; cursor: not-allowed; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; max-width: 450px; margin: auto; display: flex; justify-content: space-around; background-color: #fff; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); padding: 10px 0; border-top-left-radius: 20px; border-top-right-radius: 20px; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #999; cursor: pointer; font-size: 0.8em; }
        .nav-item.active { color: var(--primary-dark-green); }
        .nav-item i { font-size: 1.5em; margin-bottom: 5px; }

        /* --- Auth Screen --- */
        #auth-container { height: 100vh; display: flex; justify-content: center; align-items: center; }
        #auth-screen { text-align: center; width: 100%; }
        #auth-screen h2 { color: var(--primary-dark-green); }
        .auth-form { display: flex; flex-direction: column; gap: var(--spacing-md); max-width: 320px; margin: var(--spacing-lg) auto; }
        .auth-form input { padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 1em; }
        .auth-form button { background: var(--grad-green); color: var(--text-light); padding: 12px; }
        .toggle-auth { color: var(--primary-green); cursor: pointer; margin-top: var(--spacing-md); }
        .app-content { display: none; }

        /* --- Home Screen --- */
        #home-screen .earn-card { background: var(--grad-green); color: var(--text-light); display: flex; padding: var(--spacing-lg); overflow: hidden; position: relative; min-height: 150px; }
        #home-screen .earn-card-content { z-index: 2; position: relative; max-width: 65%; }
        #home-screen .earn-card-img { width: 60%; height:auto; position: absolute; bottom: -10px; right: -25px; z-index: 1; filter: drop-shadow(0 4px 10px rgba(0,0,0,0.3)); }
        #home-screen .earn-card-content h1 { font-family: 'Poppins', sans-serif; font-weight: 900; font-size: 2.8em; margin: 0; line-height: 1.0; letter-spacing: -2px; color: #fff; text-shadow: 0px 4px 8px rgba(0, 0, 0, 0.25); }
        #home-screen .earn-card-content p { margin: 8px 0 16px 0; font-size: 0.95em; font-weight: 400; opacity: 0.9; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .btn-explore { background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); color: var(--text-light); border-radius: 20px; padding: 10px 22px; font-weight: 700; text-transform: none; font-family: 'Poppins', sans-serif; font-size: 0.85em; text-shadow: 0 1px 2px rgba(0,0,0,0.1); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-explore i { margin-left: 8px; font-size: 0.9em; }
        #home-screen .rewards-banner { background: var(--grad-red); text-align: center; color: white; font-weight: 500; padding: 12px; }
        #home-screen .task-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
        #home-screen .task-item:last-child { border-bottom: none; }
        .task-info { display: flex; align-items: center; gap: var(--spacing-md); }
        .task-info i { font-size: 2em; width: 32px; text-align: center; }
        .fa-youtube { color: #FF0000; } .fa-instagram { color: #E4405F; } .fa-twitter { color: #1DA1EE; } .fa-thumbs-up { color: #3b5998; }
        .task-info div p { margin: 0; font-weight: 500; } .task-info div small { color: var(--text-subtle); }
        
        /* --- Win More & Sub-Pages --- */
        .win-more-card { display: flex; align-items: center; gap: var(--spacing-md); padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--border-radius); margin-bottom: var(--spacing-md); color: #4a3f35; }
        .win-more-card.clickable { cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; justify-content: space-between; }
        .win-more-card.clickable:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
        .win-more-card .card-text { flex-grow: 1; }
        .win-more-card i.fa-chevron-right { color: var(--text-subtle); font-size: 1.2em; }
        .win-more-card img { width: 95px; flex-shrink: 0; }
        .win-more-card .card-text h4 { margin: 0 0 5px 0; font-size: 1.1em; font-weight: 700; }
        .win-more-card .card-text p { margin: 0; font-size: 0.9em; color: var(--text-subtle); }
        .lucky-wheel { background: var(--grad-lucky-wheel); } .daily-checkin { background: var(--grad-daily-checkin); } .subscribe { background: var(--grad-subscribe); } .invitation-star { background: var(--grad-invitation); }
        .sub-page-content { text-align: center; padding: var(--spacing-lg) var(--spacing-md); }
        .sub-page-content img { max-width: 150px; margin-bottom: var(--spacing-lg); }
        .sub-page-content p { color: var(--text-subtle); max-width: 300px; margin: var(--spacing-md) auto; }
        
        /* --- Wallet Screen --- */
        .balance-card { background: var(--grad-green); color: white; text-align: center; position: relative; overflow: hidden; }
        .balance-amount { font-size: 2.5em; font-weight: 700; margin: 10px 0; }
        .detail-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
        .detail-item:last-child { border-bottom: none; }
        
        /* --- Athena Screen --- */
        #athena-screen .mining-container { background-color: var(--mining-dark-bg); color: var(--text-light); padding: var(--spacing-lg); text-align: center; border-radius: var(--border-radius); }
        .mining-container h3 { font-weight: 300; color: var(--primary-green); text-transform: uppercase; letter-spacing: 1.5px; margin-top: 0; }
        .miner-visual { position: relative; width: 200px; height: 200px; margin: var(--spacing-lg) auto; border-radius: 50%; background: radial-gradient(circle, #2d3748 0%, var(--mining-dark-bg) 70%); display: flex; justify-content: center; align-items: center; box-shadow: inset 0 0 15px rgba(0,0,0,0.5); }
        .miner-visual::before, .miner-visual::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; border-radius: 50%; border: 2px solid rgba(56, 249, 215, 0.3); animation: pulse 2.5s linear infinite; }
        .miner-visual::after { animation-delay: 1.25s; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 0.6; } 100% { transform: scale(1.6); opacity: 0; } }
        .miner-icon { font-size: 4.5em; color: var(--mining-teal); text-shadow: 0 0 25px var(--mining-teal); animation: float 4s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .mined-amount h2 { font-size: 3em; font-weight: 700; margin: 0; color: var(--text-light); letter-spacing: -1px; }
        .mined-amount p { margin: 0 0 var(--spacing-lg) 0; color: var(--text-subtle); }
        .mining-timer { margin-bottom: var(--spacing-lg); font-size: 1.2em; font-weight: 500; color: var(--primary-orange); }
        .btn-mine { background: var(--grad-green); color: var(--text-dark); width: 90%; padding: 16px 0; font-size: 1.1em; box-shadow: 0 4px 20px rgba(56, 249, 215, 0.3); }
        .btn-mine:disabled { background: #4a5568; color: #a0aec0; cursor: not-allowed; box-shadow: none; }

        /* --- Styles for the Lucky Wheel --- */
        .wheel-container { position: relative; width: 280px; height: 280px; margin: 20px auto; display: flex; justify-content: center; align-items: center; }
        .wheel-pointer { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 25px solid transparent; border-right: 25px solid transparent; border-top: 40px solid #c0392b; z-index: 10; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); }
        #lucky-wheel { position: relative; width: 100%; height: 100%; border-radius: 50%; border: 8px solid #f8d79a; overflow: hidden; transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1); background: conic-gradient( #3498db 0deg 45deg, #e67e22 45deg 90deg, #2ecc71 90deg 135deg, #e74c3c 135deg 180deg, #9b59b6 180deg 225deg, #f1c40f 225deg 270deg, #1abc9c 270deg 315deg, #e91e63 315deg 360deg ); }
        .wheel-segment { position: absolute; width: 35%; height: 5%; top: 50%; left: 50%; transform-origin: 0% 0%; display: flex; justify-content: center; align-items: center; font-weight: bold; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); font-size: 1.1em; padding-left: 25px; }
        .wheel-segment:nth-child(1) { transform: rotate(22.5deg) skewY(45deg); } .wheel-segment:nth-child(2) { transform: rotate(67.5deg) skewY(45deg); } .wheel-segment:nth-child(3) { transform: rotate(112.5deg) skewY(45deg); } .wheel-segment:nth-child(4) { transform: rotate(157.5deg) skewY(45deg); } .wheel-segment:nth-child(5) { transform: rotate(202.5deg) skewY(45deg); } .wheel-segment:nth-child(6) { transform: rotate(247.5deg) skewY(45deg); } .wheel-segment:nth-child(7) { transform: rotate(292.5deg) skewY(45deg); } .wheel-segment:nth-child(8) { transform: rotate(337.5deg) skewY(45deg); }
        .wheel-segment span { display: block; transform: skewY(-45deg) rotate(-67.5deg); }

        /* =============================================== */
        /* === RESPONSIVE DESIGN - MOBILE & DESKTOP === */
        /* =============================================== */
        
        /* Extra Small Devices (Phones, less than 360px) */
        @media (max-width: 359px) {
            #app { max-width: 100%; }
            .main-content { padding: 12px; }
            .header { padding: 12px; flex-wrap: wrap; }
            .header .balance, .header .ad-chances { padding: 4px 10px; font-size: 0.85em; }
            .header-title { font-size: 0.95em; position: static; transform: none; margin-top: 8px; width: 100%; text-align: center; }
            .card { padding: 12px; margin-bottom: 12px; border-radius: 12px; }
            .btn { padding: 8px 20px; font-size: 0.85em; }
            .bottom-nav { padding: 8px 0; }
            .nav-item { font-size: 0.7em; }
            .nav-item i { font-size: 1.3em; }
        }
        
        /* Small Devices (Phones, 360px - 599px) */
        @media (min-width: 360px) and (max-width: 599px) {
            #app { max-width: 100%; }
            .main-content { padding: var(--spacing-md); }
            .header-title { font-size: 1em; }
            .card { touch-action: manipulation; }
        }
        
        /* Medium Devices (Tablets, 600px - 900px) */
        @media (min-width: 600px) {
            #app { max-width: 500px; box-shadow: 0 0 40px rgba(0,0,0,0.15); }
            .main-content { padding: 20px; }
            .card { padding: 20px; }
            .btn { padding: 12px 28px; font-size: 0.95em; }
            .header { padding: 18px 20px; }
        }
        
        /* Large Devices (Small Laptops, 901px - 1199px) */
        @media (min-width: 901px) {
            #app { max-width: 550px; }
            .main-content { padding: 24px; }
            .card { padding: 24px; }
        }
        
        /* Extra Large Devices (Desktops, 1200px and up) */
        @media (min-width: 1200px) {
            #app { max-width: 600px; box-shadow: 0 0 50px rgba(0,0,0,0.2); }
            .main-content { padding: 28px; }
            .card { padding: 28px; }
            .btn { padding: 14px 32px; font-size: 1em; }
        }
        
        /* Touch Device Optimizations */
        @media (hover: none) and (pointer: coarse) {
            .btn, .nav-item, .back-btn, .task-item button { min-height: 44px; min-width: 44px; }
            .btn { padding: 12px 28px; }
        }
        
        /* Landscape Orientation for Phones */
        @media (max-height: 500px) and (orientation: landscape) {
            .header { padding: 10px var(--spacing-md); }
            .main-content { padding: 12px; }
            .card { padding: 12px; margin-bottom: 10px; }
            #app { padding-bottom: 60px; }
            .bottom-nav { padding: 6px 0; }
        }

        /* --- Styles for Modals --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 2000; padding: 20px; animation: fadeIn 0.3s ease-in-out; }
        .modal-content { background: white; padding: var(--spacing-lg); border-radius: var(--border-radius); text-align: center; box-shadow: 0 5px 25px rgba(0,0,0,0.2); max-width: 340px; width: 100%; }
        .modal-content h3 { margin-top: 0; color: var(--primary-dark-green); }
        .modal-content p { margin: var(--spacing-md) 0; color: var(--text-dark); }
        .modal-content .btn { background: var(--grad-green); color: var(--text-light); margin-top: var(--spacing-sm); }
        .withdraw-form { display: flex; flex-direction: column; gap: var(--spacing-md); margin-top: var(--spacing-md); }
        .withdraw-form .input-group { text-align: left; }
        .withdraw-form label { font-weight: 500; font-size: 0.9em; margin-bottom: 4px; display: block; }
        .withdraw-form input { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 1em; }
        .withdraw-form .balance-info { font-size: 0.85em; color: var(--text-subtle); margin-top: 4px; }
        .withdraw-buttons { display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-md); }
        .withdraw-buttons .btn { flex: 1; }
        .btn-cancel { background: #e0e0e0; color: #757575; }

        /* --- Ad Simulation Styles --- */
        #ad-simulation-modal { z-index: 9999; }
        #ad-simulation-modal .modal-content { background-color: #000; color: #fff; }
        #ad-simulation-modal h3 { color: #fff; }
        #ad-simulation-modal p { color: #ccc; }

        /* --- Styles for Invitation Page --- */
        .referral-box { background-color: #f0f2f5; padding: var(--spacing-md); border: 2px dashed var(--primary-green); border-radius: 15px; margin-top: var(--spacing-lg); }
        .referral-box p { margin: 0 0 var(--spacing-sm) 0; font-weight: 500; }
        .referral-code { font-size: 1.8em; font-weight: 700; color: var(--primary-dark-green); letter-spacing: 2px; }
        .btn-copy { background: var(--grad-green); color: white; width: 80%; margin: var(--spacing-lg) auto 0 auto; display: block; }
        .btn-copy i { margin-right: 8px; }
    </style>
</head>
<body>
    <div id="app">
        <!-- Auth Container -->
        <div id="auth-container">
            <div id="auth-screen" class="page active">
                <div id="login-form-container"><h2>Welcome Back!</h2><form class="auth-form" id="login-form"><input type="email" id="login-email" placeholder="Email" required><input type="password" id="login-password" placeholder="Password" required><button type="submit" class="btn">Login</button></form><p>Don't have an account? <span class="toggle-auth" id="show-register">Register here</span></p></div>
                <div id="register-form-container" style="display: none;"><h2>Create Account</h2><form class="auth-form" id="register-form"><input type="text" id="register-name" placeholder="Full Name" required><input type="email" id="register-email" placeholder="Email" required><input type="password" id="register-password" placeholder="Password (min. 6 chars)" required><input type="text" id="register-referral" placeholder="Referral Code (Optional)"><button type="submit" class="btn">Register</button></form><p>Already have an account? <span class="toggle-auth" id="show-login">Login here</span></p></div>
            </div>
        </div>

        <!-- Main App Content -->
        <div class="app-content">
            <header id="app-header"></header>
            <main class="main-content">
                <div id="home-screen" class="page"></div><div id="win-more-screen" class="page"></div><div id="wallet-screen" class="page"></div><div id="athena-screen" class="page"></div><div id="lucky-wheel-screen" class="page"></div><div id="daily-checkin-screen" class="page"></div><div id="invitation-star-screen" class="page"></div>
            </main>
            <nav class="bottom-nav">
                <div class="nav-item" data-target="home-screen"><i class="fas fa-home"></i><span>Home</span></div><div class="nav-item" data-target="win-more-screen"><i class="fas fa-gift"></i><span>Win</span></div><div class="nav-item" data-target="wallet-screen"><i class="fas fa-wallet"></i><span>Wallet</span></div><div class="nav-item" data-target="athena-screen"><i class="fas fa-robot"></i><span>Mine</span></div>
            </nav>
        </div>
        
        <!-- Modals -->
        <div id="popup-modal" class="modal-overlay" style="display: none;"><div class="modal-content"><h3 id="popup-title">Title</h3><p id="popup-message">Message</p><button id="popup-close" class="btn">Got it!</button></div></div>
        <div id="withdraw-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content"><h3>Request Withdrawal</h3><form id="withdraw-form" class="withdraw-form"><div class="input-group"><label for="withdraw-amount">Amount (NPR)</label><input type="number" id="withdraw-amount" placeholder="e.g., 50" step="0.01" required><p class="balance-info">Available: <span id="withdraw-balance-info">NPR 0.00</span></p></div><div class="input-group"><label for="withdraw-tournament-id">NP_Tournament ID</label><input type="text" id="withdraw-tournament-id" placeholder="9822089852" required></div><div class="withdraw-buttons"><button type="button" id="withdraw-cancel" class="btn btn-cancel">Cancel</button><button type="submit" class="btn">Submit</button></div></form></div>
        </div>
        <div id="ad-simulation-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <h3>Showing Rewarded Ad</h3>
                <p>Please wait... <span id="ad-timer">10</span>s</p>
                <i class="fas fa-film fa-3x fa-spin"></i>
            </div>
        </div>

        <!-- Proof Submission Modal -->
        <div id="proof-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <h3>Submit Task Proof</h3>
                <p style="color: var(--text-subtle); margin-bottom: var(--spacing-md);">Upload proof that you completed this task</p>
                <form id="proof-form" class="withdraw-form">
                    <input type="hidden" id="proof-task-index">
                    <div class="input-group">
                        <label for="proof-title">Title / Description</label>
                        <input type="text" id="proof-title" placeholder="e.g., Subscribed to channel" required>
                    </div>
                    <div class="input-group">
                        <label for="proof-image">Screenshot URL</label>
                        <input type="url" id="proof-image" placeholder="https://imgur.com/xyz.png or https://i.imgur.com/xyz.png" required>
                        <p class="balance-info">Upload your screenshot to imgur.com or imgbb.com and paste the direct image link</p>
                    </div>
                    <div class="withdraw-buttons">
                        <button type="button" id="proof-cancel" class="btn btn-cancel">Cancel</button>
                        <button type="submit" class="btn">Submit Proof</button>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <!-- SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script><script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script><script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script><script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- Monetag Ad Network Integration -->
    <script type="text/javascript" src="https://frozenbiopsyskate.com/wsfq6nwsvx?key=9e15fed1450d14881415b2d2b221ebd8"></script>
    <!-- Monetag Popunder Ad Script -->
    <script type='text/javascript' src='//frozenbiopsyskate.com/c3/6c/65/c36c651f0714c98a3b10c0a132f8f3fc.js'></script>
    <!-- Monetag Popunder Configuration -->
    <script type="text/javascript">
        var ad_idzone = "5256078",
        ad_width = "1",
        ad_height = "1",
        ad_protocol = "https";
    </script>
    
    <script>
        // Ad integration handler - Click ad link or wait 20 seconds
        const monetag = {
            showRewarded: (onSuccess, onError) => {
                console.log("Showing rewarded ad...");
                
                try {
                    // Open ad in new window
                    const adWindow = window.open('https://frozenbiopsyskate.com/wsfq6nwsvx?key=9e15fed1450d14881415b2d2b221ebd8', '_blank');
                    
                    // Create ad overlay
                const adContainer = document.createElement('div');
                adContainer.id = 'monetag-ad-container';
                    adContainer.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:9999;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:20px;';
                    
                    // Instructions
                    const instructions = document.createElement('div');
                    instructions.style.cssText = 'color:white;font-size:18px;margin-bottom:30px;text-align:center;max-width:500px;';
                    instructions.innerHTML = '<i class="fas fa-info-circle"></i><br><br><strong>Watch the ad to earn your reward!</strong><br><br>Click the ad link that opened in a new tab<br>OR<br>Wait 20 seconds here';
                    adContainer.appendChild(instructions);
                    
                    // Click Ad Button
                    const clickAdBtn = document.createElement('a');
                    clickAdBtn.href = 'https://frozenbiopsyskate.com/wsfq6nwsvx?key=9e15fed1450d14881415b2d2b221ebd8';
                    clickAdBtn.target = '_blank';
                    clickAdBtn.textContent = '🔗 Click Ad Link';
                    clickAdBtn.style.cssText = 'display:block;padding:15px 30px;background:#007bff;color:white;border:none;border-radius:8px;font-weight:bold;font-size:18px;margin-bottom:20px;text-decoration:none;cursor:pointer;box-shadow:0 4px 6px rgba(0,0,0,0.3);';
                    adContainer.appendChild(clickAdBtn);
                    
                    // Timer display
                    const timerDisplay = document.createElement('div');
                    timerDisplay.style.cssText = 'color:#FFD700;font-size:24px;font-weight:bold;margin-bottom:20px;';
                    timerDisplay.textContent = 'Wait: 20s';
                    adContainer.appendChild(timerDisplay);
                    
                    // Close button (disabled initially)
                const closeBtn = document.createElement('button');
                    closeBtn.textContent = 'Close (Wait 20s)';
                    closeBtn.style.cssText = 'padding:15px 40px;background:#ff4444;color:white;border:none;border-radius:8px;font-weight:bold;cursor:not-allowed;font-size:18px;box-shadow:0 4px 6px rgba(0,0,0,0.3);';
                closeBtn.disabled = true;
                adContainer.appendChild(closeBtn);
                    
                document.body.appendChild(adContainer);
                
                    let adCompleted = false;
                    
                    // Track if user clicks the ad link
                    clickAdBtn.onclick = () => {
                        if (!adCompleted) {
                            adCompleted = true;
                            setTimeout(() => {
                                if (document.body.contains(adContainer)) {
                                    document.body.removeChild(adContainer);
                                    console.log("Ad clicked - reward granted!");
                                    if (onSuccess) onSuccess();
                                }
                            }, 2000); // Small delay to ensure click is registered
                        }
                    };
                    
                    // Countdown timer (20 seconds)
                    let countdown = 20;
                const timer = setInterval(() => {
                    countdown--;
                        timerDisplay.textContent = `Wait: ${countdown}s`;
                    
                    if (countdown <= 0) {
                        clearInterval(timer);
                            timerDisplay.textContent = '✓ Complete!';
                            closeBtn.textContent = 'Claim Reward ✓';
                        closeBtn.style.background = '#28a745';
                        closeBtn.style.cursor = 'pointer';
                        closeBtn.disabled = false;
                        
                        closeBtn.onclick = () => {
                                if (!adCompleted) {
                                    adCompleted = true;
                            document.body.removeChild(adContainer);
                                    console.log("Ad completed - reward granted!");
                            if (onSuccess) onSuccess();
                                }
                        };
                        }
                    }, 1000);
                
                } catch (error) {
                    console.error('Ad loading error:', error);
                    // If ad fails, still allow the action
                        if (onSuccess) onSuccess();
                    }
            }
        };
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const firebaseConfig = {
            apiKey: "AIzaSyD7VBKWQz1AtL8mH1pIGoFpBtSbjRMtTcM",
            authDomain: "calm-streamer-457306-a6.firebaseapp.com",
            databaseURL: "https://calm-streamer-457306-a6-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "calm-streamer-457306-a6",
            storageBucket: "calm-streamer-457306-a6.firebasestorage.app",
            messagingSenderId: "345577494838",
            appId: "1:345577494838:web:57f0e304805ac1ba223b97",
            measurementId: "G-P7EMF693PS"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let appState = { currentPage: 'home-screen', currentUser: null, userData: null, userRef: null, isSpinning: false };
        let dynamicUiInterval;

        // --- UI HELPER FUNCTIONS ---
        const popupModal = document.getElementById('popup-modal');
        const showPopup = (title, message) => { document.getElementById('popup-title').textContent = title; document.getElementById('popup-message').textContent = message; if (popupModal) popupModal.style.display = 'flex'; };
        const hidePopup = () => { if (popupModal) popupModal.style.display = 'none'; };
        document.getElementById('popup-close').addEventListener('click', hidePopup);

        const withdrawModal = document.getElementById('withdraw-modal');
        const showWithdrawModal = () => { document.getElementById('withdraw-balance-info').textContent = `NPR ${appState.userData.balance.toFixed(2)}`; document.getElementById('withdraw-form').reset(); if(withdrawModal) withdrawModal.style.display = 'flex'; };
        const hideWithdrawModal = () => { if(withdrawModal) withdrawModal.style.display = 'none'; };
        document.getElementById('withdraw-cancel').addEventListener('click', hideWithdrawModal);
        
        const triggerConfetti = () => { confetti({ particleCount: 150, spread: 100, origin: { y: 0.6 } }); };
        
        const formatTime = (ms) => {
            if (ms <= 0) return 'Available Now!';
            const h = String(Math.floor((ms / 3600000) % 24)).padStart(2, '0'), m = String(Math.floor((ms / 60000) % 60)).padStart(2, '0'), s = String(Math.floor((ms / 1000) % 60)).padStart(2, '0');
            return `Available in ${h}:${m}:${s}`;
        };

        // --- RENDER FUNCTIONS ---
        const renderHeader = () => {
            const headerContainer = document.getElementById('app-header');
            if (!headerContainer || !appState.userData) return;
            headerContainer.className = 'header';
            const subPageTitles = { 'lucky-wheel-screen': 'Lucky Wheel', 'daily-checkin-screen': 'Daily Check-in', 'invitation-star-screen': 'Invite Friends' };
            const pageTitle = subPageTitles[appState.currentPage];
            if (pageTitle) { headerContainer.innerHTML = `<span class="back-btn" data-target="win-more-screen"><i class="fas fa-arrow-left"></i></span><div class="header-title">${pageTitle}</div><span></span>`; } 
            else { headerContainer.innerHTML = `<span id="logout-btn" style="cursor:pointer;"><i class="fas fa-sign-out-alt"></i></span><div class="balance-info"><div class="balance">NPR ${appState.userData.balance.toFixed(2)}</div><div class="ad-chances"><i class="fas fa-video"></i> Unlimited</div></div>`; }
        };

        const syncGlobalTasks = () => {
            database.ref('globalTasks').once('value', globalSnapshot => {
                const globalTasks = globalSnapshot.val() || {};
                const userTasks = appState.userData.socialTasks || [];
                
                // Merge global tasks with user tasks, preserving claimed status and other user data
                const mergedTasks = Object.entries(globalTasks).map(([taskId, task]) => {
                    const existingTask = userTasks.find(t => t.id === taskId);
                    return {
                        id: taskId,
                        name: task.name,
                        reward: task.reward,
                        link: task.link,
                        icon: task.icon,
                        platform: task.platform || 'Task',
                        category: task.category || 'General',
                        approvalType: task.approvalType || 'automatic',
                        autoApproveSeconds: task.autoApproveSeconds || 30,
                        status: existingTask ? existingTask.status : 'pending',
                        startTime: existingTask?.startTime || null,
                        submittedAt: existingTask?.submittedAt || null
                    };
                });
                
                if (JSON.stringify(mergedTasks) !== JSON.stringify(userTasks)) {
                    appState.userRef.update({ socialTasks: mergedTasks });
                }
            });
        };

        const renderHomePage = () => {
            const homeScreen = document.getElementById('home-screen');
            if(!homeScreen || !appState.userData) return;
            homeScreen.innerHTML = `<section class="card earn-card"><div class="earn-card-content"><h1>Earn<br>Money</h1><p>Your Daily Rewards Hub</p><button class="btn btn-explore" id="go-to-win-page">Explore <i class="fas fa-arrow-right"></i></button></div><img height="105%" style="margin-right:5%" src="images/lucky-wheel.png" alt="Earn Money" class="earn-card-img"></section><section class="card rewards-banner"><p>DOUBLE REWARDS - LIVE NOW!</p></section><section class="card"><h3><i class="fas fa-star" style="color: orange;"></i> Task Center</h3><div id="task-list"></div></section>`;
            const taskListContainer = document.getElementById('task-list');
            const tasks = appState.userData.socialTasks || [];
            if (tasks.length > 0) {
                taskListContainer.innerHTML = tasks.map((task, index) => {
                    let buttonHtml = '';
                    let buttonClass = 'btn btn-get';
                    let disabled = '';
                    
                    if (task.status === 'claimed') {
                        buttonHtml = 'Claimed';
                        buttonClass = 'btn btn-claimed';
                        disabled = 'disabled';
                    } else if (task.status === 'processing') {
                        const elapsed = Math.floor((Date.now() - (task.startTime || 0)) / 1000);
                        const remaining = Math.max(0, (task.autoApproveSeconds || 30) - elapsed);
                        buttonHtml = `Wait ${remaining}s...`;
                        buttonClass = 'btn btn-claimed';
                        disabled = 'disabled';
                    } else if (task.status === 'pending_approval') {
                        buttonHtml = 'Pending Review';
                        buttonClass = 'btn btn-claimed';
                        disabled = 'disabled';
                    } else {
                        buttonHtml = '<i class="fas fa-video"></i>Get';
                    }
                    
                    return `<div class="task-item"><div class="task-info"><i class="${task.icon}"></i><div><p>${task.name}</p><small>Reward: NPR ${task.reward.toFixed(2)} • ${task.platform || 'Task'}</small></div></div><button class="${buttonClass}" data-task-index="${index}" ${disabled}>${buttonHtml}</button></div>`;
                }).join('');
            } else {
                taskListContainer.innerHTML = `<p style="text-align:center; color: #999;">No tasks available.</p>`;
            }
        };
        
        const renderWalletPage = () => { 
            if (!appState.userData) return;
            const transactions = appState.userData.transactions ? Object.values(appState.userData.transactions) : [];
            const sortedTransactions = transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            const transactionsHtml = sortedTransactions.map(tx => `<div class="detail-item"><div><p>${tx.description}</p><small style="color: #888;">${new Date(tx.date).toLocaleString()}</small></div><span style="color: ${tx.amount >= 0 ? 'var(--primary-green)' : 'red'}; font-weight: bold;">${tx.amount >= 0 ? '+' : ''} ${tx.amount.toFixed(2)} NPR</span></div>`).join(''); 
            document.getElementById('wallet-screen').innerHTML = `<section class="card balance-card"><div style="z-index: 2; position: relative;"><p style="margin:0; opacity: 0.8;">Total Balance</p><h2 class="balance-amount">NPR ${appState.userData.balance.toFixed(2)}</h2><button id="withdraw-btn" class="btn btn-get" style="background: white; color: black;">Withdraw</button></div></section><section class="card"><h4>Transactions</h4>${transactionsHtml || '<p style="text-align:center; color: #999;">No transactions yet.</p>'}</section>`;
        };
        
        const renderWinMorePage = () => { 
            document.getElementById('win-more-screen').innerHTML = `<div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: var(--spacing-lg); margin-bottom: var(--spacing-md);"><h3 style="margin-top: 0; color: white;"><i class="fas fa-gift"></i> Redeem Coupon Code</h3><p style="margin-bottom: var(--spacing-md); opacity: 0.9;">Enter a coupon code to claim your reward!</p><div style="display: flex; gap: 10px;"><input type="text" id="coupon-input" placeholder="Enter code (e.g., WELCOME2024)" style="flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 1em; text-transform: uppercase;"><button id="redeem-coupon-btn" class="btn" style="background: white; color: #667eea; font-weight: bold; padding: 12px 24px;">Redeem</button></div></div><div class="card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: var(--spacing-lg); margin-bottom: var(--spacing-md);"><h3 style="margin-top: 0; color: white;"><i class="fas fa-video"></i> Watch Ads & Earn</h3><p style="margin-bottom: var(--spacing-md); opacity: 0.9;">Watch a 20-second ad and earn NPR 0.05 instantly!</p><button id="watch-ad-earn-btn" class="btn" style="background: white; color: #28a745; font-weight: bold; padding: 12px 24px; width: 100%;"><i class="fas fa-play-circle"></i> Watch Ad - Earn NPR 0.05</button></div><div class="win-more-card lucky-wheel clickable" data-target="lucky-wheel-screen"><img src="images/lucky-wheel.png" alt="Lucky Wheel"><div class="card-text"><h4>LUCKY WHEEL TO WIN</h4><p>Spin daily for cash prizes</p></div><i class="fas fa-chevron-right"></i></div><div class="win-more-card daily-checkin clickable" data-target="daily-checkin-screen"><img src="images/daily-reward.png" alt="Daily Check-in"><div class="card-text"><h4>DAILY CHECK-IN</h4><p>GET FREE CASH</p></div><i class="fas fa-chevron-right"></i></div><div class="win-more-card subscribe clickable" data-target="home-screen"><img src="images/social-subscribe.png" alt="Subscribe"><div class="card-text"><h4>GO SUBSCRIBE</h4><p>MORE ABOUT EARNING</p></div><i class="fas fa-chevron-right"></i></div><div class="win-more-card invitation-star clickable" data-target="invitation-star-screen"><img src="images/invitation-star.png" alt="Invitation"><div class="card-text"><h4>Invite Friends</h4><p>Earn rewards with your friends</p></div><i class="fas fa-chevron-right"></i></div>`;
        };
        
        const renderInvitationStarPage = () => {
            const referralLink = `${window.location.origin}${window.location.pathname}?ref=${appState.userData.referralCode || ''}`;
            const shareMessage = `Join this amazing earning app and get NPR 10 bonus! Use my referral code: ${appState.userData.referralCode}`;
            
            document.getElementById('invitation-star-screen').innerHTML = `<div class="card sub-page-content"><img src="images/invitation-star.png" alt="Invitation Star"><h2>Invite & Earn NPR 10!</h2><p>Share your code with friends. When they sign up, you BOTH get NPR 10! Unlimited referrals!</p><div class="referral-box"><p>Your Unique Referral Code</p><span class="referral-code">${appState.userData.referralCode || '...'}</span></div><div style="display: flex; flex-direction: column; gap: 12px; margin-top: 20px;"><button id="copy-referral-code-btn" class="btn btn-copy" style="background: var(--grad-green); color: white;"><i class="fas fa-copy"></i> Copy Referral Code</button><button id="copy-referral-link-btn" class="btn btn-copy" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;"><i class="fas fa-link"></i> Copy Referral Link</button><button id="share-whatsapp-btn" class="btn btn-copy" style="background: #25D366; color: white;"><i class="fab fa-whatsapp"></i> Share on WhatsApp</button></div></div>`;
            
            // Add event listeners for sharing buttons
            setTimeout(() => {
                document.getElementById('copy-referral-code-btn')?.addEventListener('click', () => {
                    const code = appState.userData.referralCode;
                    if(navigator.clipboard && code) {
                        navigator.clipboard.writeText(code).then(() => showPopup('Copied!', 'Referral code copied to clipboard!')).catch(() => showPopup('Error', 'Could not copy the code.'));
                    }
                });
                
                document.getElementById('copy-referral-link-btn')?.addEventListener('click', () => {
                    if(navigator.clipboard) {
                        navigator.clipboard.writeText(referralLink).then(() => showPopup('Copied!', 'Referral link copied to clipboard!')).catch(() => showPopup('Error', 'Could not copy the link.'));
                    }
                });
                
                document.getElementById('share-whatsapp-btn')?.addEventListener('click', () => {
                    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareMessage + '\n\n' + referralLink)}`;
                    window.open(whatsappUrl, '_blank');
                });
            }, 100);
        };
        
        const renderAthenaPage = () => { 
            document.getElementById('athena-screen').innerHTML = `<div class="mining-container"><h3>Athena AI Miner</h3><div class="miner-visual"><i class="fas fa-robot miner-icon"></i></div><div class="mined-amount"><h2 id="mined-value">0.00000</h2><p>Mined (NPR)</p></div><div id="mining-timer" class="mining-timer">Ready to start</div><button id="mining-action-btn" class="btn btn-mine">Activate</button></div><div class="card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: var(--spacing-lg); margin-top: var(--spacing-md);"><h3 style="margin-top: 0; color: white;"><i class="fas fa-video"></i> Watch Ads & Earn</h3><p style="margin-bottom: var(--spacing-md); opacity: 0.9;">Watch a 20-second ad and earn NPR 0.05 instantly!</p><button id="athena-watch-ad-btn" class="btn" style="background: white; color: #28a745; font-weight: bold; padding: 12px 24px; width: 100%;"><i class="fas fa-play-circle"></i> Watch Ad - Earn NPR 0.05</button></div>`;
        };
        const renderDailyCheckinPage = () => { 
            document.getElementById('daily-checkin-screen').innerHTML = `<div class="card sub-page-content"><img src="images/daily-reward.png" alt="Daily Check-in"><h2>Daily Check-in</h2><p>Login every day to claim your free cash reward!</p><button id="daily-checkin-btn" class="btn btn-get" style="width: 80%; margin: auto; display: block;"><i class="fas fa-video"></i>CHECK-IN</button><p id="checkin-timer" style="margin-top: 1em; font-weight: 500;"></p></div>`;
        };
        const renderLuckyWheelPage = () => { 
            document.getElementById('lucky-wheel-screen').innerHTML = `<div class="card sub-page-content"><div class="wheel-container"><div class="wheel-pointer"></div><div id="lucky-wheel">${[{t:'NPR 0.1'},{t:'NPR 0.5'},{t:'NPR 1'},{t:'NPR 2'},{t:'NPR 3'},{t:'NPR 5'},{t:'NPR 8'},{t:'NPR 10'}].map(p=>`<div class="wheel-segment"><span>${p.t}</span></div>`).join('')}</div></div><h2>Spin the Lucky Wheel!</h2><p>Win between NPR 0.1 to NPR 10! You have 30 spins daily with 5-minute cooldown.</p><button id="spin-wheel-btn" class="btn btn-get" style="width: 80%; display: block; margin: auto;"><i class="fas fa-video"></i>SPIN NOW</button><p id="spin-timer" style="margin-top: 1em; font-weight: 500;"></p></div>`;
        };
        const updateDynamicUI = () => {
            if (!appState.userData) return;
            const now = Date.now();
            if (appState.currentPage === 'athena-screen' && appState.userData.mining) {
                const { isMining, lastClaimTimestamp, ratePerHour, claimInterval } = appState.userData.mining;
                const [minedValueEl, timerEl, buttonEl] = [document.getElementById('mined-value'), document.getElementById('mining-timer'), document.getElementById('mining-action-btn')];
                if (minedValueEl && timerEl && buttonEl) {
                    if (!isMining) { minedValueEl.textContent = '0.00000'; timerEl.textContent = 'Ready to start'; buttonEl.textContent = 'Activate'; buttonEl.disabled = false; } 
                    else {
                        const elapsedTime = now - lastClaimTimestamp;
                        if (elapsedTime >= claimInterval) { minedValueEl.textContent = ((claimInterval / 3600000) * ratePerHour).toFixed(5); timerEl.textContent = 'Claim Now!'; buttonEl.textContent = 'Claim'; buttonEl.disabled = false; } 
                        else { minedValueEl.textContent = ((elapsedTime / 3600000) * ratePerHour).toFixed(5); const rem = claimInterval - elapsedTime; timerEl.textContent = `Time Remaining: ${formatTime(rem).replace('Available in ','')}`; buttonEl.textContent = 'Mining...'; buttonEl.disabled = true; }
                    }
                }
            }
            if(appState.currentPage === 'daily-checkin-screen' && appState.userData) {
                const ONE_DAY_MS = 24 * 60 * 60 * 1000;
                const [buttonEl, timerEl] = [document.getElementById('daily-checkin-btn'), document.getElementById('checkin-timer')];
                if(buttonEl && timerEl) {
                    const timeSinceCheckin = now - (appState.userData.lastCheckinTimestamp || 0);
                    if (timeSinceCheckin < ONE_DAY_MS) { buttonEl.disabled = true; buttonEl.classList.add('btn-claimed'); buttonEl.innerHTML = 'Claimed Today'; timerEl.textContent = formatTime(ONE_DAY_MS - timeSinceCheckin); } 
                    else { buttonEl.disabled = false; buttonEl.classList.remove('btn-claimed'); buttonEl.innerHTML = '<i class="fas fa-video"></i>CHECK-IN'; timerEl.textContent = 'Your daily reward is ready!'; }
                }
            }
            if(appState.currentPage === 'lucky-wheel-screen' && appState.userData.luckyWheel) {
                const [buttonEl, timerEl] = [document.getElementById('spin-wheel-btn'), document.getElementById('spin-timer')];
                if(buttonEl && timerEl) {
                    const { spinsRemaining, cooldownUntil, lastSpinTime } = appState.userData.luckyWheel;
                    const fiveMinutes = 5 * 60 * 1000; // 5 minutes in milliseconds
                    
                    if (appState.isSpinning) { 
                        buttonEl.disabled = true; buttonEl.innerHTML = 'Spinning...'; 
                    }
                    else if (lastSpinTime && now - lastSpinTime < fiveMinutes) {
                        const remainingCooldown = fiveMinutes - (now - lastSpinTime);
                        buttonEl.disabled = true; 
                        buttonEl.classList.add('btn-claimed'); 
                        buttonEl.innerHTML = 'Cooldown'; 
                        timerEl.textContent = formatTime(remainingCooldown);
                    }
                    else if (cooldownUntil && now < cooldownUntil) { 
                        buttonEl.disabled = true; 
                        buttonEl.classList.add('btn-claimed'); 
                        buttonEl.innerHTML = 'Daily Limit Reached'; 
                        timerEl.textContent = formatTime(cooldownUntil - now) + ' until reset'; 
                    } 
                    else if (cooldownUntil && now >= cooldownUntil) { 
                        database.ref(`/users/${appState.currentUser.uid}/luckyWheel`).update({ spinsRemaining: 30, cooldownUntil: null, lastSpinTime: null }); 
                    }
                    else {
                        if (spinsRemaining <= 0) { 
                            buttonEl.disabled = true; 
                            buttonEl.innerHTML = 'No Spins Left'; 
                            timerEl.textContent = 'Check back tomorrow for more spins!';
                        }
                        else { 
                            buttonEl.disabled = false; 
                            buttonEl.classList.remove('btn-claimed'); 
                            buttonEl.innerHTML = `<i class="fas fa-video"></i>SPIN NOW (${spinsRemaining} left)`; 
                            timerEl.textContent = `You have ${spinsRemaining} spin(s) remaining.`; 
                        }
                    }
                }
            }
        };

        const executeTransaction = (updates) => { database.ref().update(updates).catch(err => showPopup('Error', err.message)); };

        // --- CORE HANDLER FUNCTIONS ---
        
        const showVideoAd = (onAdComplete, onAdError) => {
            // Unlimited video ads - no limit check
            monetag.showRewarded(() => {
                if(onAdComplete) onAdComplete();
            }, () => {
                showPopup('Ad Error', 'The video ad could not be loaded. Please try again.');
                if(onAdError) onAdError();
            });
        };

        const handleTaskGetClick = (taskIndex) => {
            const task = appState.userData.socialTasks[taskIndex];
            if (!task || task.status !== 'pending') return;
            
            // Directly open the task link without showing ad
            window.open(task.link, '_blank');
            
            // Update task status to started
            {
                
                const uid = appState.currentUser.uid;
                
                if (task.approvalType === 'automatic') {
                    // Automatic approval with timer
                    const waitSeconds = task.autoApproveSeconds || 30;
                    
                    // Mark as processing
                    const updates = {};
                    updates[`/users/${uid}/socialTasks/${taskIndex}/status`] = 'processing';
                    updates[`/users/${uid}/socialTasks/${taskIndex}/startTime`] = Date.now();
                    executeTransaction(updates);
                    
                    showPopup('Task Started', `Complete the task! Auto-approval in ${waitSeconds} seconds. Keep this page open.`);
                    
                    // Auto-approve after timer
                    setTimeout(() => {
                        const finalUpdates = {};
                        const newTxKey = database.ref(`/users/${uid}/transactions`).push().key;
                        finalUpdates[`/users/${uid}/socialTasks/${taskIndex}/status`] = 'claimed';
                        finalUpdates[`/users/${uid}/balance`] = appState.userData.balance + task.reward;
                        finalUpdates[`/users/${uid}/transactions/${newTxKey}`] = {
                            date: new Date().toISOString(),
                            description: `${task.name} (${task.platform})`,
                            amount: task.reward
                        };
                        executeTransaction(finalUpdates);
                        showPopup('Task Approved!', `You earned NPR ${task.reward.toFixed(2)}!`);
                        triggerConfetti();
                    }, waitSeconds * 1000);
                    
                } else {
                    // Manual approval - show proof submission modal
                    document.getElementById('proof-task-index').value = taskIndex;
                    document.getElementById('proof-form').reset();
                    document.getElementById('proof-modal').style.display = 'flex';
                }
            }
        };

        const handleProofSubmit = (e) => {
            e.preventDefault();
            const taskIndex = parseInt(document.getElementById('proof-task-index').value);
            const proofTitle = document.getElementById('proof-title').value.trim();
            const proofImage = document.getElementById('proof-image').value.trim();
            
            if (!proofTitle || !proofImage) {
                showPopup('Error', 'Please fill in all fields.');
                return;
            }

            const uid = appState.currentUser.uid;
            const updates = {};
            updates[`/users/${uid}/socialTasks/${taskIndex}/status`] = 'pending_approval';
            updates[`/users/${uid}/socialTasks/${taskIndex}/submittedAt`] = Date.now();
            updates[`/users/${uid}/socialTasks/${taskIndex}/proofTitle`] = proofTitle;
            updates[`/users/${uid}/socialTasks/${taskIndex}/proofImage`] = proofImage;
            
            executeTransaction(updates);
            document.getElementById('proof-modal').style.display = 'none';
            showPopup('Submitted!', 'Task proof submitted for admin review. You will receive the reward once approved.');
        };

        const handleMiningAction = () => {
            const { isMining, lastClaimTimestamp, ratePerHour, claimInterval } = appState.userData.mining;
            const uid = appState.currentUser.uid;
            const now = Date.now();

            if (!isMining) { 
                database.ref(`/users/${uid}/mining`).update({ isMining: true, lastClaimTimestamp: now }); 
                document.getElementById('mining-action-btn').textContent = 'Mining...';
                document.getElementById('mining-action-btn').disabled = true;
            } else if (now - lastClaimTimestamp >= claimInterval) {
                const reward = (claimInterval / 3600000) * ratePerHour;
                const updates = {};
                const newTxKey = database.ref(`/users/${uid}/transactions`).push().key;
                updates[`/users/${uid}/balance`] = appState.userData.balance + reward;
                updates[`/users/${uid}/mining`] = { ...appState.userData.mining, isMining: false, lastClaimTimestamp: null };
                updates[`/users/${uid}/transactions/${newTxKey}`] = { date: new Date().toISOString(), description: 'Athena AI Miner Reward', amount: reward };
                executeTransaction(updates);
                showPopup('Reward Claimed!', `You received NPR ${reward.toFixed(5)} from the miner!`);
            }
        };

        const handleDailyCheckin = () => {
            const ONE_DAY_MS = 24 * 60 * 60 * 1000;
            if (Date.now() - (appState.userData.lastCheckinTimestamp || 0) < ONE_DAY_MS) { 
                showPopup('Already Claimed', 'You can claim your daily reward once every 24 hours.'); 
                return; 
            }

            showVideoAd(() => {
                const reward = 3.00;
                const updates = {};
                const uid = appState.currentUser.uid;
                const newTxKey = database.ref(`/users/${uid}/transactions`).push().key;
                updates[`/users/${uid}/balance`] = appState.userData.balance + reward;
                updates[`/users/${uid}/lastCheckinTimestamp`] = Date.now();
                updates[`/users/${uid}/transactions/${newTxKey}`] = { date: new Date().toISOString(), description: 'Daily Check-in Reward', amount: reward };
                executeTransaction(updates);
                showPopup('Reward Claimed!', `You received NPR ${reward.toFixed(2)}!`); 
                triggerConfetti();
            });
        };
        
        const handleSpinWheel = () => {
            const { spinsRemaining, cooldownUntil, lastSpinTime } = appState.userData.luckyWheel;
            const now = Date.now();
            const fiveMinutes = 5 * 60 * 1000;
            
            if (appState.isSpinning) return;
            
            // Check 5-minute cooldown between spins
            if (lastSpinTime && now - lastSpinTime < fiveMinutes) { 
                showPopup('Cooldown Active', 'Please wait 5 minutes between spins.'); 
                return; 
            }
            
            // Check daily limit cooldown
            if (cooldownUntil && now < cooldownUntil) { 
                showPopup('Daily Limit Reached', 'You have used all 30 spins today. Come back tomorrow!'); 
                return; 
            }
            
            if (spinsRemaining <= 0) { 
                showPopup('No Spins Left', 'You have used all your spins for today. Check back tomorrow!'); 
                return; 
            }

            // Directly open ad link (like task button)
            window.open('https://frozenbiopsyskate.com/wsfq6nwsvx?key=9e15fed1450d14881415b2d2b221ebd8', '_blank');
            
            appState.isSpinning = true;
            updateDynamicUI();
            
            // Wait 3 seconds then spin the wheel
            setTimeout(() => {
                const wheelEl = document.getElementById('lucky-wheel');
                const segments = wheelEl.querySelectorAll('.wheel-segment span');
                const winningIndex = Math.floor(Math.random() * segments.length);
                const prizeText = segments[winningIndex].textContent;
                const prizeValue = parseFloat(prizeText.replace('NPR ', '')) || 0;
                const finalRotation = ( (Math.floor(Math.random() * 3) + 5) * 360 ) - (winningIndex * 45) - 157.5;

                wheelEl.style.transition = 'transform 5s cubic-bezier(0.25, 0.1, 0.25, 1)';
                wheelEl.style.transform = `rotate(${finalRotation}deg)`;
                
                setTimeout(() => {
                    appState.isSpinning = false;
                    const uid = appState.currentUser.uid;
                    const newSpins = spinsRemaining - 1;
                    const updates = {};
                    updates[`/users/${uid}/luckyWheel/spinsRemaining`] = newSpins;
                    updates[`/users/${uid}/luckyWheel/lastSpinTime`] = now;

                    // Set daily cooldown if all spins used
                    if (newSpins <= 0) { 
                        updates[`/users/${uid}/luckyWheel/cooldownUntil`] = now + (24 * 60 * 60 * 1000); 
                    }
                    
                    if (prizeValue > 0) {
                        updates[`/users/${uid}/balance`] = appState.userData.balance + prizeValue;
                        const newTxKey = database.ref(`/users/${uid}/transactions`).push().key;
                        updates[`/users/${uid}/transactions/${newTxKey}`] = { date: new Date().toISOString(), description: 'Lucky Wheel Prize', amount: prizeValue };
                        showPopup('Congratulations!', `You won NPR ${prizeValue.toFixed(2)}!`);
                        triggerConfetti();
                    } else { 
                        showPopup('Better Luck!', 'Try again for bigger prizes!'); 
                    }
                    executeTransaction(updates);
                    
                    wheelEl.style.transition = 'none';
                    const actualFinalRotation = finalRotation % 360;
                    wheelEl.style.transform = `rotate(${actualFinalRotation}deg)`;

                    updateDynamicUI();
                }, 5500);
            }, 3000);
        };
        
        const handleWithdrawal = (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            const tournamentId = document.getElementById('withdraw-tournament-id').value.trim();
            const minWithdraw = 20;

            if (isNaN(amount) || amount <= 0) { showPopup('Invalid Amount', 'Please enter a valid positive number.'); return; }
            if (amount < minWithdraw) { showPopup('Amount Too Low', `Minimum withdrawal is NPR ${minWithdraw}.`); return; }
            if (amount > appState.userData.balance) { showPopup('Insufficient Funds', 'You cannot withdraw more than your balance.'); return; }
            if (!tournamentId || tournamentId.length < 5) { showPopup('Invalid Tournament ID', 'Please enter a valid NP_Tournament ID.'); return; }

            const updates = {};
            const uid = appState.currentUser.uid;
            const newTxKey = database.ref(`/users/${uid}/transactions`).push().key;
            updates[`/users/${uid}/balance`] = appState.userData.balance - amount;
            updates[`/users/${uid}/transactions/${newTxKey}`] = { date: new Date().toISOString(), description: `Withdrawal to ${tournamentId}`, amount: -amount };
            executeTransaction(updates);
            hideWithdrawModal();
            showPopup('Success!', `Your withdrawal request for NPR ${amount.toFixed(2)} is submitted.`);
        };

        // Popunder Ad System - Every 2 Minutes + Page Navigation
        let popunderInterval;
        let lastPopunderTime = 0;
        let popunderReady = false;
        
        const initPopunderAds = () => {
            // Mark popunder as ready after scripts load
            setTimeout(() => {
                popunderReady = true;
                console.log('Popunder ads initialized and ready');
            }, 2000);
        };
        
        const triggerPopunder = () => {
            if (!popunderReady) return;
            
            const now = Date.now();
            // Allow popunder every 2 minutes (120000 ms)
            if (now - lastPopunderTime < 120000) return;
            
            lastPopunderTime = now;
            
            // Multiple trigger methods for better compatibility
            try {
                // Method 1: Direct click on body
                document.body.click();
                
                // Method 2: Create and dispatch click event
                const clickEvent = new MouseEvent('click', {
                    view: window,
                    bubbles: true,
                    cancelable: true,
                    clientX: 0,
                    clientY: 0
                });
                document.body.dispatchEvent(clickEvent);
                
                // Method 3: Trigger on a link element
                const tempLink = document.createElement('a');
                tempLink.href = '#';
                tempLink.style.display = 'none';
                document.body.appendChild(tempLink);
                tempLink.click();
                setTimeout(() => document.body.removeChild(tempLink), 100);
                
                console.log('Popunder triggered at', new Date().toLocaleTimeString());
            } catch (error) {
                console.error('Popunder trigger error:', error);
            }
        };
        
        const startPopunderAds = () => {
            initPopunderAds();
            
            // Add click listener to trigger on user interactions
            let clickCount = 0;
            document.addEventListener('click', () => {
                clickCount++;
                if (clickCount % 5 === 0) {
                    setTimeout(triggerPopunder, 500);
                }
            });
            
            // Trigger on page navigation
            const originalShowPage = showPage;
            window.showPage = (pageId) => {
                originalShowPage(pageId);
                setTimeout(triggerPopunder, 1500);
            };
            
            // Trigger first popunder after 5 seconds
            setTimeout(triggerPopunder, 5000);
            
            // Then trigger every 2 minutes (120,000 ms)
            popunderInterval = setInterval(triggerPopunder, 120000);
        };

        // Auto-fill referral code from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const urlReferralCode = urlParams.get('ref');
        if (urlReferralCode) {
            setTimeout(() => {
                const referralInput = document.getElementById('register-referral');
                if (referralInput) {
                    referralInput.value = urlReferralCode.toUpperCase();
                }
            }, 500);
        }

        const handleRedeemCoupon = () => {
            const couponInput = document.getElementById('coupon-input');
            const code = couponInput.value.trim().toUpperCase();
            
            if (!code) {
                showPopup('Invalid Code', 'Please enter a coupon code.');
                return;
            }

            const couponRef = database.ref(`coupons/${code}`);
            couponRef.once('value', snapshot => {
                if (!snapshot.exists()) {
                    showPopup('Invalid Code', 'This coupon code does not exist.');
                    couponInput.value = '';
                    return;
                }

                const coupon = snapshot.val();
                const now = Date.now();
                const expiryDate = new Date(coupon.expiryDate).getTime();
                const usedCount = coupon.usedCount || 0;
                const usageLimit = coupon.usageLimit || 1;
                const redeemedByUsers = coupon.redeemedByUsers || [];
                const userEmail = appState.currentUser.email;
                
                // Check if expired
                if (now > expiryDate) {
                    showPopup('Expired', 'This coupon has expired.');
                    couponInput.value = '';
                    return;
                }

                // Check if user already used this coupon
                if (redeemedByUsers.includes(userEmail)) {
                    showPopup('Already Used', 'You have already redeemed this coupon.');
                    couponInput.value = '';
                    return;
                }
                
                // Check if max usage reached
                if (usageLimit !== -1 && usedCount >= usageLimit) {
                    showPopup('Max Uses Reached', 'This coupon has reached its maximum number of uses.');
                    couponInput.value = '';
                    return;
                }

                // Redeem the coupon
                const uid = appState.currentUser.uid;
                const updates = {};
                const newTxKey = database.ref(`/users/${uid}/transactions`).push().key;
                
                updates[`/users/${uid}/balance`] = appState.userData.balance + coupon.reward;
                updates[`/users/${uid}/transactions/${newTxKey}`] = {
                    date: new Date().toISOString(),
                    description: `Coupon Code: ${code}`,
                    amount: coupon.reward
                };
                
                // Update coupon usage
                updates[`/coupons/${code}/usedCount`] = usedCount + 1;
                
                // Add user to redeemed list
                const newRedeemedList = [...redeemedByUsers, userEmail];
                updates[`/coupons/${code}/redeemedByUsers`] = newRedeemedList;

                executeTransaction(updates);
                showPopup('Success!', `You received NPR ${coupon.reward.toFixed(2)} from coupon ${code}!`);
                triggerConfetti();
                couponInput.value = '';
            });
        };

        const handleWatchAdEarn = () => {
            if (!appState.currentUser || !appState.userData) return;
            
            // Initialize lastAdWatchTime if not exists
            if (!appState.userData.lastAdWatchTime) {
                appState.userData.lastAdWatchTime = 0;
            }
            
            const now = Date.now();
            const threeMinutes = 3 * 60 * 1000;
            const timeSinceLastAd = now - appState.userData.lastAdWatchTime;
            
            // Check 3-minute cooldown
            if (timeSinceLastAd < threeMinutes) {
                const remainingTime = Math.ceil((threeMinutes - timeSinceLastAd) / 1000);
                const minutes = Math.floor(remainingTime / 60);
                const seconds = remainingTime % 60;
                showPopup('Cooldown Active', `Please wait ${minutes}m ${seconds}s before watching another ad.`);
                return;
            }
            
            monetag.showRewarded(
                // onAdComplete: This runs after watching the ad
                () => {
                    const uid = appState.currentUser.uid;
                    const reward = 0.05;
                    const updates = {};
                    const newTxKey = database.ref(`/users/${uid}/transactions`).push().key;
                    
                    updates[`/users/${uid}/balance`] = appState.userData.balance + reward;
                    updates[`/users/${uid}/lastAdWatchTime`] = now;
                    updates[`/users/${uid}/transactions/${newTxKey}`] = {
                        date: new Date().toISOString(),
                        description: 'Watch Ad Reward',
                        amount: reward
                    };
                    
                    executeTransaction(updates);
                    showPopup('Earned!', `You earned NPR ${reward.toFixed(2)} for watching the ad!`);
                    triggerConfetti();
                },
                // onAdError: This runs if ad fails
                () => {
                    showPopup('Ad Error', 'Please check your internet connection and try again.');
                }
            );
        };

        let showPage = (pageId) => {
            appState.currentPage = pageId;
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId)?.classList.add('active');
            const subPagesOfWin = ['lucky-wheel-screen', 'daily-checkin-screen', 'invitation-star-screen'];
            document.querySelectorAll('.nav-item').forEach(item => item.classList.toggle('active', item.dataset.target === (subPagesOfWin.includes(pageId) ? 'win-more-screen' : pageId)));
            renderHeader();
            const renderMap = { 'home-screen': renderHomePage, 'wallet-screen': renderWalletPage, 'athena-screen': renderAthenaPage, 'lucky-wheel-screen': renderLuckyWheelPage, 'daily-checkin-screen': renderDailyCheckinPage, 'win-more-screen': renderWinMorePage, 'invitation-star-screen': renderInvitationStarPage };
            renderMap[pageId]?.();
            updateDynamicUI();
        };

        // --- AUTH & APP INITIALIZATION ---
        const authContainer = document.getElementById('auth-container');
        const appContent = document.querySelector('.app-content');
        
        auth.onAuthStateChanged(user => {
            if (user) {
                appState.currentUser = user;
                if (appState.userRef) appState.userRef.off();
                appState.userRef = database.ref('users/' + user.uid);
                
                appState.userRef.on('value', (snapshot) => {
                    if (!snapshot.exists()) {
                        const defaultUserData = {
                            name: user.email.split('@')[0],
                            email: user.email, 
                            balance: 0.0, 
                            referralCode: user.uid.substring(0, 8).toUpperCase(),
                            socialTasks: [],
                            transactions: {}, 
                            mining: { isMining: false, ratePerHour: 0.05, lastClaimTimestamp: null, claimInterval: 3600000 }, 
                            lastCheckinTimestamp: null, 
                            luckyWheel: { spinsRemaining: 30, cooldownUntil: null, lastSpinTime: null },
                        };
                        appState.userRef.set(defaultUserData);
                        appState.userData = defaultUserData;
                        syncGlobalTasks(); // Sync global tasks for new user
                    } else {
                        const userData = snapshot.val();
                        const updates = {};
                        if (!userData.name) updates.name = user.email.split('@')[0];
                        if (!userData.luckyWheel) updates.luckyWheel = { spinsRemaining: 30, cooldownUntil: null, lastSpinTime: null };
                        if (!userData.luckyWheel?.lastSpinTime) updates['luckyWheel/lastSpinTime'] = null;
                        if (userData.luckyWheel?.spinsRemaining === 5) updates['luckyWheel/spinsRemaining'] = 30;
                        if (userData.lastCheckinTimestamp === undefined) updates.lastCheckinTimestamp = null;
                        if (!userData.referralCode) updates.referralCode = user.uid.substring(0, 8).toUpperCase();
                        if (!userData.socialTasks) updates.socialTasks = [];
                        if (!userData.mining) updates.mining = { isMining: false, ratePerHour: 0.05, lastClaimTimestamp: null, claimInterval: 3600000 };

                        if (Object.keys(updates).length > 0) appState.userRef.update(updates);
                        appState.userData = { ...userData, ...updates };
                        syncGlobalTasks(); // Sync global tasks
                    }
                    authContainer.style.display = 'none'; appContent.style.display = 'block';
                    showPage(appState.currentPage);
                });
                if (!dynamicUiInterval) dynamicUiInterval = setInterval(updateDynamicUI, 1000);
                
                // Start popunder ads
                startPopunderAds();
            } else {
                if (appState.userRef) appState.userRef.off();
                appState.currentUser = null; appState.userData = null;
                clearInterval(dynamicUiInterval); dynamicUiInterval = null;
                clearInterval(popunderInterval);
                authContainer.style.display = 'flex'; appContent.style.display = 'none';
            }
        });

        document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value).catch(err => showPopup('Login Error', err.message)); });
        document.getElementById('register-form').addEventListener('submit', (e) => { 
            e.preventDefault(); 
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const referralCode = document.getElementById('register-referral').value.trim().toUpperCase();
            
            auth.createUserWithEmailAndPassword(email, password).then((userCredential) => {
                const uid = userCredential.user.uid;
                
                // Initialize user data with name
                const defaultUserData = {
                    name: name,
                    email: email, 
                    balance: 0.0, 
                    referralCode: uid.substring(0, 8).toUpperCase(),
                    socialTasks: [],
                    transactions: {}, 
                    mining: { isMining: false, ratePerHour: 0.05, lastClaimTimestamp: null, claimInterval: 3600000 }, 
                    lastCheckinTimestamp: null, 
                    luckyWheel: { spinsRemaining: 30, cooldownUntil: null, lastSpinTime: null },
                    referredBy: referralCode || null
                };
                
                database.ref(`users/${uid}`).set(defaultUserData).then(() => {
                    // If user used a referral code, give both users 10 NPR bonus
                    if (referralCode) {
                        database.ref('users').orderByChild('referralCode').equalTo(referralCode).once('value', snapshot => {
                            if (snapshot.exists()) {
                                const referrerData = snapshot.val();
                                const referrerId = Object.keys(referrerData)[0];
                                const referrer = referrerData[referrerId];
                                
                                const bonusAmount = 10;
                                const updates = {};
                                
                                // Give bonus to new user
                                const newUserTxKey = database.ref(`users/${uid}/transactions`).push().key;
                                updates[`users/${uid}/balance`] = bonusAmount;
                                updates[`users/${uid}/transactions/${newUserTxKey}`] = {
                                    date: new Date().toISOString(),
                                    description: 'Referral Bonus - Welcome!',
                                    amount: bonusAmount
                                };
                                
                                // Give bonus to referrer
                                const referrerTxKey = database.ref(`users/${referrerId}/transactions`).push().key;
                                updates[`users/${referrerId}/balance`] = (referrer.balance || 0) + bonusAmount;
                                updates[`users/${referrerId}/transactions/${referrerTxKey}`] = {
                                    date: new Date().toISOString(),
                                    description: `Referral Bonus - ${name} joined!`,
                                    amount: bonusAmount
                                };
                                
                                database.ref().update(updates);
                                showPopup('Welcome!', `You received NPR ${bonusAmount} referral bonus!`);
                            }
                        });
                    }
                });
            }).catch(err => showPopup('Registration Error', err.message)); 
        });
        document.getElementById('show-register').addEventListener('click', () => { document.getElementById('login-form-container').style.display = 'none'; document.getElementById('register-form-container').style.display = 'block'; });
        document.getElementById('show-login').addEventListener('click', () => { document.getElementById('register-form-container').style.display = 'none'; document.getElementById('login-form-container').style.display = 'block'; });
        document.getElementById('withdraw-form').addEventListener('submit', handleWithdrawal);
        document.getElementById('proof-form').addEventListener('submit', handleProofSubmit);
        document.getElementById('proof-cancel').addEventListener('click', () => { document.getElementById('proof-modal').style.display = 'none'; });

        document.getElementById('app').addEventListener('click', (event) => {
            const target = event.target.closest('[data-target], [data-task-index], #mining-action-btn, #go-to-win-page, #daily-checkin-btn, #spin-wheel-btn, #logout-btn, #withdraw-btn, #redeem-coupon-btn, #watch-ad-earn-btn, #athena-watch-ad-btn');
            if (!target) return;
            const targetId = target.id;
            if (target.dataset.target) showPage(target.dataset.target);
            else if (target.dataset.taskIndex) handleTaskGetClick(parseInt(target.dataset.taskIndex, 10));
            else if (targetId === 'mining-action-btn') handleMiningAction();
            else if (targetId === 'go-to-win-page') showPage('win-more-screen');
            else if (targetId === 'daily-checkin-btn') handleDailyCheckin();
            else if (targetId === 'spin-wheel-btn') handleSpinWheel();
            else if (targetId === 'withdraw-btn') showWithdrawModal();
            else if (targetId === 'redeem-coupon-btn') handleRedeemCoupon();
            else if (targetId === 'watch-ad-earn-btn') handleWatchAdEarn();
            else if (targetId === 'athena-watch-ad-btn') handleWatchAdEarn();
            else if (targetId === 'logout-btn') auth.signOut();
        });
    });
    </script>
<script type='text/javascript' src='//frozenbiopsyskate.com/24/3e/0f/243e0f2aafa8f672ae6efe83eec30cc9.js'></script>
</body>
</html>